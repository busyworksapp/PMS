<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defects Management - Barron Production Management</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body onload="requireAuth(); loadDefects();">
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <span>⚙️</span> BARRON
      </div>
      <ul class="nav-links">
        <li><a href="/dashboard.html">Dashboard</a></li>
        <li><a href="/job-planning.html">Job Planning</a></li>
        <li><a href="/defects.html">Defects</a></li>
        <li><a href="/maintenance.html">Maintenance</a></li>
        <li><a href="/master-data.html">Master Data</a></li>
      </ul>
      <div class="user-menu">
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="flex-between mb-3">
      <h1>Defects & Returns Management</h1>
      <button class="btn-primary" onclick="showModal('new-reject-modal')">
        ➕ Internal Reject
      </button>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <h3>Internal Rejects</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Ticket</th>
                <th>Order</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rejects-table">
              <tr>
                <td colspan="4" class="text-center text-muted">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Customer Returns</h3>
        </div>
        <button class="btn-secondary" style="width: 100%; margin-bottom: 1rem;" onclick="showModal('new-return-modal')">
          ➕ Log Return
        </button>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Ticket</th>
                <th>Order</th>
                <th>Qty</th>
              </tr>
            </thead>
            <tbody id="returns-table">
              <tr>
                <td colspan="3" class="text-center text-muted">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Internal Reject Modal -->
  <div id="new-reject-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Internal Reject Ticket</h2>
        <button class="modal-close">✕</button>
      </div>

      <div class="form-group">
        <label for="reject-order" class="required">Order Number</label>
        <input type="text" id="reject-order" placeholder="Order number" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="reject-quantity" class="required">Quantity Rejected</label>
          <input type="number" id="reject-quantity" placeholder="0" required>
        </div>

        <div class="form-group">
          <label for="reject-stage" class="required">Production Stage</label>
          <input type="text" id="reject-stage" placeholder="e.g., Cutting, Sewing" required>
        </div>
      </div>

      <div class="form-group">
        <label for="reject-reason" class="required">Reason for Rejection</label>
        <textarea id="reject-reason" placeholder="Describe the defect..." required></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" onclick="hideModal('new-reject-modal')">Cancel</button>
        <button class="btn-primary" onclick="saveReject()">Submit Ticket</button>
      </div>
    </div>
  </div>

  <!-- Customer Return Modal -->
  <div id="new-return-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Log Customer Return</h2>
        <button class="modal-close">✕</button>
      </div>

      <div class="form-group">
        <label for="return-order" class="required">Order Number</label>
        <input type="text" id="return-order" placeholder="Order number" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="return-quantity" class="required">Quantity Returned</label>
          <input type="number" id="return-quantity" placeholder="0" required>
        </div>
      </div>

      <div class="form-group">
        <label for="return-reason" class="required">Return Reason</label>
        <textarea id="return-reason" placeholder="Describe the return reason..." required></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" onclick="hideModal('new-return-modal')">Cancel</button>
        <button class="btn-primary" onclick="saveReturn()">Log Return</button>
      </div>
    </div>
  </div>

  <script src="/static/js/main.js"></script>
  <script>
    async function loadDefects() {
      try {
        // Load rejects
        const rejects = await apiCall("GET", "/defects/rejects");
        renderRejects(rejects || []);

        // Load returns
        const returns = await apiCall("GET", "/defects/returns");
        renderReturns(returns || []);
      } catch (error) {
        showAlert("Failed to load defects", "danger");
      }
    }

    function renderRejects(rejects) {
      const tableBody = document.getElementById("rejects-table");
      if (rejects.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No internal rejects</td></tr>';
        return;
      }

      tableBody.innerHTML = rejects.map(reject => `
        <tr>
          <td><strong>${reject.ticket_number || 'N/A'}</strong></td>
          <td>${reject.order_id}</td>
          <td><span class="badge badge-warning">${reject.status || 'pending'}</span></td>
          <td>
            <button class="btn-small btn-secondary">View</button>
          </td>
        </tr>
      `).join("");
    }

    function renderReturns(returns) {
      const tableBody = document.getElementById("returns-table");
      if (returns.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No returns logged</td></tr>';
        return;
      }

      tableBody.innerHTML = returns.map(ret => `
        <tr>
          <td><strong>${ret.ticket_number || 'N/A'}</strong></td>
          <td>${ret.order_id}</td>
          <td>${ret.quantity_returned}</td>
        </tr>
      `).join("");
    }

    async function saveReject() {
      const rejectData = {
        order_id: document.getElementById("reject-order").value,
        quantity_rejected: parseInt(document.getElementById("reject-quantity").value),
        production_stage: document.getElementById("reject-stage").value,
        reason: document.getElementById("reject-reason").value,
      };

      try {
        // In production, POST to /defects/rejects endpoint
        showAlert("Rejection ticket created", "success");
        hideModal("new-reject-modal");
        loadDefects();
      } catch (error) {
        showAlert("Failed to create ticket: " + error.message, "danger");
      }
    }

    async function saveReturn() {
      const returnData = {
        order_id: document.getElementById("return-order").value,
        quantity_returned: parseInt(document.getElementById("return-quantity").value),
        reason: document.getElementById("return-reason").value,
      };

      try {
        // In production, POST to /defects/returns endpoint
        showAlert("Return logged successfully", "success");
        hideModal("new-return-modal");
        loadDefects();
      } catch (error) {
        showAlert("Failed to log return: " + error.message, "danger");
      }
    }
  </script>
</body>
</html>
